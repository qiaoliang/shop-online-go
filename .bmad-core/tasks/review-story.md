# 审查故事(review-story)

当开发代理将故事标记为"准备审查"时，执行全面的高级开发人员代码审查，能够直接重构和改进代码。

## 先决条件(Prerequisites)

- 故事状态必须为"审查"
- 开发人员已完成所有任务并更新了文件列表
- 所有自动化测试都通过

## 审查过程(Review Process)

1. **阅读完整故事(Read the Complete Story)**
    - 审查所有验收标准
    - 理解开发笔记和要求
    - 注意开发人员的任何完成说明

2. **根据开发笔记指导验证实施(Verify Implementation Against Dev Notes Guidance)**
    - 审查"开发笔记"部分，了解提供给开发人员的具体技术指导
    - 验证开发人员的实施是否遵循开发笔记中指定的架构模式
    - 检查文件位置是否与开发笔记中的项目结构指导匹配
    - 确认开发笔记中指定的任何库、框架或技术方法都正确使用
    - 验证开发笔记中提到的安全考虑是否已实施

3. **关注文件列表(Focus on the File List)**
    - 验证列出的所有文件是否实际创建/修改
    - 检查是否有应该更新但缺失的文件
    - 确保文件位置与开发笔记中的项目结构指导一致

4. **高级开发人员代码审查(Senior Developer Code Review)**
    - 以高级开发人员的眼光审查代码
    - 如果更改形成一个连贯的整体，一起审查它们
    - 如果更改是独立的，逐个文件增量审查
    - 重点关注：
        - 代码架构和设计模式
        - 重构机会
        - 代码重复或低效
        - 性能优化
        - 安全问题
        - 最佳实践和模式

5. **主动重构(Active Refactoring)**
    - 作为高级开发人员，您可以并且应该在需要改进的地方重构代码
    - 重构时：
        - 直接在文件中进行更改
        - 解释为什么要进行更改
        - 描述更改如何改进代码
        - 确保重构后所有测试仍然通过
        - 如果修改了其他文件，更新文件列表

6. **标准合规性检查(Standards Compliance Check)**
    - 验证对 `docs/coding-standards.md` 的遵守
    - 检查对 `docs/unified-project-structure.md` 的合规性
    - 根据 `docs/testing-strategy.md` 验证测试方法
    - 确保遵循故事中提到的所有指导原则

7. **验收标准验证(Acceptance Criteria Validation)**
    - 验证每个 AC 是否完全实施
    - 检查是否有缺失的功能
    - 验证边缘情况是否得到处理

8. **测试覆盖审查(Test Coverage Review)**
    - 确保单元测试涵盖边缘情况
    - 如果缺少关键覆盖，添加缺失的测试
    - 验证集成测试（如果需要）是否全面
    - 检查测试断言是否有意义
    - 寻找缺失的测试场景

9. **文档和注释(Documentation and Comments)**
    - 验证代码在可能的情况下是否自文档化
    - 如果缺失，为复杂逻辑添加注释
    - 确保记录任何 API 更改

## 更新故事文件 - 仅限 QA 结果部分(Update Story File - QA Results Section ONLY)

**关键**：您仅有权更新故事文件的"QA 结果"部分。不要修改任何其他部分。

审查和任何重构后，将您的结果附加到故事文件的 QA 结果部分：

```markdown
## QA 结果(QA Results)

### 审查日期(Review Date): [日期]

### 审查者(Reviewed By): Quinn (高级开发人员 QA)

### 代码质量评估(Code Quality Assessment)

[实施质量的整体评估]

### 执行的重构(Refactoring Performed)

[列出您执行的任何重构并解释]

- **文件**: [文件名]
    - **更改**: [更改了什么]
    - **原因**: [更改原因]
    - **方式**: [如何改进代码]

### 合规性检查(Compliance Check)

- 编码标准: [✓/✗] [如有说明]
- 项目结构: [✓/✗] [如有说明]
- 测试策略: [✓/✗] [如有说明]
- 所有 AC 满足: [✓/✗] [如有说明]

### 改进清单(Improvements Checklist)

[勾选您自己处理的项目，未勾选的项目留给开发人员处理]

- [x] 重构用户服务以更好地处理错误 (services/user.service.ts)
- [x] 添加缺失的边缘情况测试 (services/user.service.test.ts)
- [ ] 考虑将验证逻辑提取到单独的验证器类
- [ ] 为错误场景添加集成测试
- [ ] 更新新错误代码的 API 文档

### 安全审查(Security Review)

[发现的任何安全问题以及是否已解决]

### 性能考虑(Performance Considerations)

[发现的任何性能问题以及是否已解决]

### 最终状态(Final Status)

[✓ 批准 - 准备完成] / [✗ 需要更改 - 见上面未勾选的项目]
```

## 关键原则(Key Principles)

- 您是审查初级/中级工作的高级开发人员
- 您有直接改进代码的权限和责任
- 始终解释您的更改以用于学习目的
- 在完美和实用主义之间取得平衡
- 专注于重要改进，而不是吹毛求疵

## 阻塞条件(Blocking Conditions)

如果出现以下情况，停止审查并请求澄清：

- 故事文件不完整或缺少关键部分
- 文件列表为空或明显不完整
- 需要测试时不存在测试
- 代码更改与故事要求不一致
- 需要讨论的关键架构问题

## 完成(Completion)

审查后：

1. 如果所有项目都已勾选并批准：将故事状态更新为"完成"
2. 如果仍有未勾选的项目：保持状态为"审查"供开发人员处理
3. 始终提供建设性反馈和解释以用于学习
