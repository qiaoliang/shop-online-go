# 书店应用 E2E 测试指南

本文档提供了如何对书店应用进行端到端(E2E)测试的说明，特别是针对用户收货地址管理功能。

## 准备工作

1. 确保已安装 [Postman](https://www.postman.com/downloads/)
2. 确保已安装 Go 环境

## 测试步骤

### 1. 启动测试服务器

进入E2Etest目录并使用提供的脚本启动测试服务器：

```bash
cd E2Etest
./start-test-server.sh
```

这将使用测试配置文件 `config-test.yaml` 启动服务器，该配置使用 SQLite 数据库而不是生产环境的 MySQL。

### 2. 导入 Postman 测试集合

1. 打开 Postman
2. 点击 "Import" 按钮
3. 选择 `E2Etest/bookstore-address-api-tests.postman_collection.json` 文件
4. 导入完成后，您将看到 "书店地址API测试" 集合

### 3. 设置认证令牌

由于 API 需要用户认证，您可以使用提供的登录脚本获取认证令牌：

```bash
cd E2Etest
./login-test-user.sh
```

这个脚本会尝试登录系统自带的admin用户（手机号：13900007997，密码：1234）并获取认证令牌。

获取令牌后：

1. 复制输出的令牌
2. 在 Postman 集合的 "Authorization" 标签页中，选择 "Bearer Token" 类型
3. 将复制的令牌粘贴到 Token 字段中

### 4. 运行测试

测试集合包含以下测试用例：

1. **添加收货地址** - 测试成功添加一个新的收货地址
2. **添加收货地址 - 无效数据** - 测试使用无效数据添加地址时的错误处理
3. **添加第二个默认地址** - 测试添加第二个默认地址时，之前的默认地址是否被正确更新

您可以单独运行每个测试，或者使用 Postman 的 "Run Collection" 功能一次运行所有测试。

### 5. 验证结果

测试运行后，Postman 将显示每个测试的结果。成功的测试将显示绿色勾号，失败的测试将显示红色叉号。

## 测试数据验证

如果您想验证数据是否正确保存到数据库，可以使用 SQLite 工具查看测试数据库：

```bash
cd .. # 返回项目根目录
sqlite3 test.db
```

然后执行 SQL 查询：

```sql
SELECT * FROM addresses;
```

## 注意事项

- 测试服务器使用端口 9090，确保该端口未被其他应用占用
- 测试数据库文件为 `test.db`，位于项目根目录，每次启动测试服务器时会重新创建
- 启动服务器时会自动执行数据库迁移脚本，创建必要的表结构
- 如果您修改了代码，需要重启测试服务器以应用更改
- 所有E2E测试相关的文件都位于 `E2Etest` 目录中
